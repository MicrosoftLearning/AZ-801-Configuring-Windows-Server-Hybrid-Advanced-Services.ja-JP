---
lab:
  title: 'ラボ: ハイブリッド シナリオでの運用監視の実装'
  type: Answer Key
  module: Module 9 - Implementing operational monitoring in hybrid scenarios
ms.openlocfilehash: b68d5e88d5a550967a2cba67b57465993299ee22
ms.sourcegitcommit: fb0d39e25bc0fe182037587b772d217db126d3bb
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/07/2022
ms.locfileid: "144813010"
---
# <a name="lab-answer-key-implementing-operational-monitoring-in-hybrid-scenarios"></a>ラボの回答キー: ハイブリッド シナリオでの運用監視の実装

## <a name="exercise-1-preparing-a-monitoring-environment"></a>演習 1: 監視環境の準備

#### <a name="task-1-deploy-an-azure-virtual-machine"></a>タスク 1: Azure 仮想マシンをデプロイする

1. **SEA-SVR2** に接続し、必要であれば、パスワード "**Pa55w.rd**" を使用して **CONTOSO\\Administrator** としてサインインします。
1. **SEA-SVR2** で Microsoft Edge を起動し、 **[Azure portal](https://portal.azure.com)** に移動します。そして、このラボで使用するサブスクリプションの所有者ロールをもつユーザー アカウントの資格情報を使用してサインインします。
1. **SEA-SVR2** で、Azure portal を表示している Microsoft Edge ウィンドウで、Azure portal の [Cloud Shell] をクリックして [Azure Cloud Shell] ウィンドウを開きます。
1. **Bash** または **PowerShell** の選択を求めるメッセージが表示されたら、 **[PowerShell]** を選択します。

   > **注**: Cloud Shell を起動するのが初めてで、"**ストレージがマウントされていません**" というメッセージが表示される場合は、このラボで使用しているサブスクリプションを選択してから、 **[ストレージの作成]** を選択します。

1. [Cloud Shell] ウィンドウのツールバーで、 **[ファイルのアップロード/ダウンロード]** アイコンをクリックし、表示されるボックスの一覧で **[アップロード]** をクリックし、ファイル **C:\\Labfiles\\Lab09\\L09-rg_template.json** を Cloud Shell のホーム ディレクトリにアップロードします。
1. 前の手順を繰り返して、ファイル **C:\\Labfiles\\Lab09\\L09-rg_template.parameters.json** を Cloud Shell のホーム ディレクトリにアップロードします。
1. ラボ環境をホスティングするリソース グループを作成するために、Cloud Shell ウィンドウの **PowerShell** セッションで次のコマンドを入力し、各コマンドの入力後には Enter キーを押します (`<Azure_region>` プレースホルダーを、このラボでリソースをデプロイする Azure リージョンの名前に置き換えます)。

   >**注**: **(Get-AzLocation).Location** コマンドを使用して、使用可能な Azure リージョンの名前を一覧表示できます。

   ```powershell 
   $location = '<Azure_region>'
   $rgName = 'AZ801-L0901-RG'
   New-AzResourceGroup -ResourceGroupName $rgName -Location $location
   ```

1. 新しく作成したリソース グループに Azure 仮想マシンをデプロイするには、次のコマンドを入力し、Enter キーを押します。

   ```powershell 
   New-AzResourceGroupDeployment -Name az801l0901deployment -ResourceGroupName $rgName -TemplateFile ./L09-rg_template.json -TemplateParameterFile ./L09-rg_template.parameters.json -AsJob
   ```

   >**注**: デプロイが完了するのを待たずに、次のタスクに進んでください。 デプロイには約 3 分かかります。

#### <a name="task-2-register-the-microsoftinsights-and-microsoftalertsmanagement-resource-providers"></a>タスク 2: Microsoft.Insights と Microsoft.AlertsManagement リソース プロバイダーを登録する

1. Microsoft.Insights と Microsoft.AlertsManagement リソース プロバイダーを登録するには、**SEA-SVR2** で、Cloud Shell ウィンドウから次のコマンドを入力し、各コマンドの入力後には Enter キーを押します。

   ```powershell
   Register-AzResourceProvider -ProviderNamespace Microsoft.Insights
   Register-AzResourceProvider -ProviderNamespace Microsoft.AlertsManagement
   ```

   >**注**: 登録状態を確認するために、**Get-AzResourceProvider** コマンドレットを使用できます。

   >**注**: 登録プロセスが完了するのを待たず、代わりに次のタスクに進んでください。 登録には約 3 分かかります。

1. Cloud Shell を閉じます。

#### <a name="task-3-create-and-configure-an-azure-log-analytics-workspace"></a>タスク 3: Azure Log Analytics ワークスペースを作成して構成する

1. Azure portal の **SVR2** の **[リソース、サービス、ドキュメントの検索]** ボックスのツールバーで **[Log Analytics ワークスペース]** を検索して選択し、 **[Log Analytics ワークスペース]** ページで **[+ 作成]** を選択します。
1. **[Log Analytics ワークスペースの作成]** ページの **[基本]** タブで、次の設定を入力し、 **[確認と作成]** を選択してから、 **[作成]** を選択します。

   | 設定 | 値 |
   | --- | --- |
   | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
   | リソース グループ | 新しいリソース グループ **AZ801-L0902-RG** の名前 |
   | Log Analytics ワークスペース | 任意の一意の名前 |
   | リージョン | 前のタスクで仮想マシンをデプロイした Azure リージョンの名前 |

   >**注**: 前のタスクで仮想マシンをデプロイしたリージョンを必ず指定してください。

   >**注**: デプロイが完了するまで待ちます。 デプロイには約 1 分かかります。

## <a name="exercise-2-configuring-monitoring-of-on-premises-servers"></a>演習 2: オンプレミス サーバーの監視の構成

#### <a name="task-1-register-windows-admin-center-with-azure"></a>タスク 1: Windows Admin Center を Azure に登録する

1. **SEA-SVR2** で **[スタート]** を選択し、 **[Windows PowerShell (管理者)]** を選択します。

   >**注**: **SEA-SVR2** に Windows Admin Center をまだインストールしていない場合は、次の 2 つの手順を行います。

1. **Windows PowerShell** コンソールで、次のコマンドを入力し、Enter キーを押して、最新バージョンの Windows Admin Center をダウンロードします。
    
   ```powershell
   Start-BitsTransfer -Source https://aka.ms/WACDownload -Destination "$env:USERPROFILE\Downloads\WindowsAdminCenter.msi"
   ```
1. 次のコマンドを入力してから Enter キーを押して、Windows Admin Center をインストールします。
    
   ```powershell
   Start-Process msiexec.exe -Wait -ArgumentList "/i $env:USERPROFILE\Downloads\WindowsAdminCenter.msi /qn /L*v log.txt REGISTRY_REDIRECT_PORT_80=1 SME_PORT=443 SSL_CERTIFICATE_OPTION=generate"
   ```

   > **注**: インストールが完了するまで待ちます。 これには 2 分ほどかかります。

   > **注**:Windows Admin Center のインストールが完了すると、エラー ERR_CONNECTION_REFUSED が表示される場合があります。 これが発生した場合は、続行する前に SEA-SVR2 を再起動してください。

1. **SEA-SVR2** で Microsoft Edge を起動し、 **https://SEA-SVR2.contoso.com** にアクセスします。 
1. ダイアログが表示されたら、 **[Windows セキュリティ]** ダイアログ ボックスに次の資格情報を入力し、 **[OK]** をクリックします。

   - ユーザー名: **CONTOSO\\Administrator**
   - パスワード: **Pa55w.rd**

1. **[すべての接続]** ウィンドウで、右上隅にある **[設定]** (歯車) アイコンをクリックします。
1. Windows Admin Center で、 **[設定]** ウィンドウの **[Azure アカウント]** セクションで、 **[Azure への登録]** 、 **[登録]** の順に選択します。
1. **[Windows Admin Center で Azure を使用して作業を開始する]** ウィンドウで **[コピー]** を選択して、登録手順のステップの一覧に表示されたコードをコピーします。 
1. 登録手順のステップの一覧で **[コードの入力]** を選択します。

   >**注**: これにより、Microsoft Edge ウィンドウに別のタブが開き、 **[コードの入力]** ページが表示されます。

1. **[コードの入力]** テキスト ボックスに、クリップボードにコピーしたコードを貼り付け、 **[次へ]** を選択します。
1. **[サインイン]** ページで、前の演習で Azure サブスクリプションへのサインインに使用したものと同じユーザー名を入力し、 **[次へ]** を選択します。次に、対応するパスワードを入力し、 **[サインイン]** を選択します。
1. 「**Windows Admin Center にサインインしますか?**」 というメッセージが表示されたら、**[続行]** を選択します。
1. Windows Admin Center で、正常にサインインしたことを確認し、Microsoft Edge ウィンドウに新しく開いたタブを閉じます。
1. **[Windows Admin Center で Azure を使用して作業を開始する]** ウィンドウで、**Azure Active Directory アプリケーション** が **[新規作成]** に設定されていることを確認した後、 **[接続]** を選択します。
1. 登録手順のステップの一覧で **[サインイン]** を選択します。 これにより、 **[要求されたアクセス許可]** というラベルの付いたポップアップ ウィンドウが開きます。
1. **[要求されたアクセス許可]** ポップアップ ウィンドウで、 **[組織の代理として同意する]** 、 **[同意する]** の順に選択します。

#### <a name="task-2-integrate-an-on-premises-windows-server-with-azure-monitor"></a>タスク 2: オンプレミスの Windows Server を Azure Monitor と統合する

1. **SEA-SVR2** で、Windows Admin Center を表示した Microsoft Edge ウィンドウで **[すべての接続]** ウィンドウを参照します。
1. **[すべての接続]** ウィンドウで **sea-svr2.contoso.com** エントリを選択します。 
1. **[sea-svr2.contoso.com]** ページで **[ツール]** メニューの **[Azure Monitor]** を選択し、次に **[Azure にサインインしてセットアップ]** を選択します。
1. **[Azure Monitor のセットアップ]** ページで、次の設定を指定し、 **[セットアップ]** をクリックします。

   | 設定 | 値 |
   | --- | --- |
   | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
   | リソース グループ | **AZ801-L0902-RG** |
   | リソース グループのリージョン | 前の演習で仮想マシンをデプロイした Azure リージョンの名前 |
   | Log Analytics ワークスペース | 前の演習で作成したワークスペースの名前 |
   | Enable Azure Arc (Azure Arc を有効にする) | オン |

   >**注**: 設定が完了するのを待たず、代わりに次の演習に進んでください。 設定には 3 分ほどかかります。

   >**注**: このプロセスにより、Log Analytics エージェントと Dependency Agent が自動的にインストールされます。

## <a name="exercise-3-configuring-monitoring-of-azure-vms"></a>演習 3: Azure VM の監視の構成

#### <a name="task-1-review-host-based-monitoring"></a>タスク 1: ホストベースの監視を確認する

1. Azure portal で、「**仮想マシン**」を検索して選択し、**[仮想マシン]** ページで **[az801l09-vm0]** を選択します。
1. **[az801l09-vm0]** ページの **[監視]** セクションで **[メトリック]** を選びます。
1. **[az801l09-vm0 \| メトリック]** ページの既定のグラフの **[メトリック名前空間]** ドロップダウン リストで、 **[仮想マシン ホスト]** メトリックのみが使用できることが分かります。

   >**注**: ゲスト レベルの診断設定がまだ構成されていないため、これは想定内です。 ただし、 **[メトリック名前空間]** ボックスの一覧で、ゲスト メモリ メトリックを直接、有効にすることができます。 これは、この演習の後半で有効にします。

1. **[メトリック]** ボックスの一覧で、使用可能なメトリックの一覧を確認します。

   >**注**: この一覧には、CPU、ディスク、ネットワークに関連する幅広いメトリックが含まれており、これらは、ゲスト レベルのメトリックにアクセスすることなく、仮想マシンのホストから収集できます。

1. **[メトリック]** ボックスの一覧で **[CPU 使用率]** を選択し、 **[集計]** ボックスの一覧で、 **[Avg]** エントリが選択されていることを確認し、結果のグラフを調べます。

#### <a name="task-2-configure-diagnostic-settings-and-vm-insights"></a>タスク 2: 診断設定と VM 分析情報を構成する

1. **[az801l09-vm0]** ページの **[監視]** セクションで **[診断設定]** を選びます。
1. **[az801l09-vm0 \| 診断設定]** ページの **[概要]** タブで **[ゲスト レベルの監視を有効にする]** を選択します。

   >**注**: 操作が有効になるまで待ちます。 これには 3 分ほどかかる場合があります。

1. **[az801l09-vm0 \| 診断設定]** ページの **[パフォーマンス カウンター]** タブに切り替えて、使用可能なカウンターを確認します。

   >**注**: 既定では、CPU、メモリ、ディスク、ネットワークのカウンターが有効になっています。 **[カスタム]** ビューに切り替えると、より詳細な一覧を確認できます。

1. **[az801l09-vm0 \| 診断設定]** ページの **[ログ]** タブに切り替え、 **[ゲスト レベルの監視を有効にする]** をクリックします。 

   >**注**: ゲスト レベルの監視の診断が有効になるまで待ちます。 これには、約 3 分かかります。

1. **[az801l09-vm0 \| 診断設定]** ページの **[概要]** タブで、使用可能なイベント ログ収集のオプションを確認します。

   >**注**: 既定では、ログの収集には、アプリケーション ログとシステム ログからの重大、エラー、および警告のエントリに加え、セキュリティ ログからの監査失敗のエントリが含まれています。 これらは、 **[ログ]** タブからカスタマイズできます。

1. **[az801l09-vm0 \| 診断設定]** ページで、 **[ログ]** タブを選択し、使用可能な構成設定を確認します。
1. **[az801l09-vm0 \| ログ]** ページで、左側にある垂直メニューの **[監視]** セクションの **[メトリック]** を選択します。
1. **[az801l09-vm0 \| メトリック]** ページの既定のグラフでは、この時点で、 **[メトリック名前空間]** ボックスの一覧に、 **[仮想マシン ホスト]** エントリに加えて **[ゲスト (クラシック)]** エントリも含まれています。

   >**注**: ゲスト レベルの診断設定を有効にしたため、これは想定どおりです。 また、 **[新しいゲスト メモリ メトリックを有効にする]** オプションもあります。

1. **[メトリック名前空間]** ボックスの一覧で **[ゲスト (クラシック)]** エントリを選択します。
1. **[メトリック]** ボックスの一覧で、使用可能なメトリックの一覧を確認し、メモリと論理ディスクに関連するさまざまなメトリックが含まれていることを確認します。

   >**注**: この一覧には、ホスト レベルの監視のみに依存している場合には使用できない、ゲスト レベルの詳細メトリックが含まれています。

1. **[メトリック名前空間]** ボックスの一覧で **[新しいゲスト メモリ メトリックを有効にする]** エントリを選択します。
1. **[ゲスト メトリック (プレビュー) を有効にする]** ウィンドウで、指定された情報を確認します。
1. **[az801l09-vm0 \| 診断設定]** ページで、 **[シンク]** タブを選択し、 **[Azure Monitor (プレビュー)]** セクションで **[有効]** を選択してから **[保存]** をクリックします。
1. **[az801l09-vm0 \| メトリック]** ページに戻ると、既定のグラフでは、この時点で、 **[メトリック名前空間]** ボックスの一覧に **[仮想マシン ホスト]** および **[ゲスト (クラシック)]** エントリに加えて、 **[仮想マシンのゲスト]** エントリも含まれています。

   >**注**: **[仮想マシンのゲスト]** エントリが表示されるように、ページを更新する必要がある場合があります。

1. **[az801l09-vm0 \| メトリック]** ページの左側の垂直メニューで **[監視]** セクションの **[ログ]** を選択します。
1. **[az801l09-vm0 \| ログ]** ページで **[有効化]** を選択します。
1. **[Log Analytics ワークスペースの選択]** ボックスの一覧で、このラボで先ほど作成した Log Analytics ワークスペースを選択し、 **[有効化]** を選択します。
1. **[az801l09-vm0 \| ログ]** ページで、左側にある垂直メニューの **[監視]** セクションの **[Insights]** を選択します。
1. 必要に応じて、 **[az801l09-vm0 \| Insights]** ページで **[有効化]** を選択します。

   >**注**: この設定により、Azure VM Insights 機能が提供されます。 VM Insights は、Azure Monitor のソリューションの 1 つで、これにより、Windows または Linux を実行する Azure VM とオンプレミス コンピューターの両方のパフォーマンスと正常性の監視が容易になります。

1. **SEA-SVR2** で、Azure portal のツールバーにある **[リソース、サービス、ドキュメントの検索]** テキスト ボックスで「**モニター**」を検索して選択します。次に **[モニター\| 概要]** ページの **[分析情報]** で **[VM の分析情報]** を選択します。
1. **[モニター \| 仮想マシン]** ページで **[パフォーマンス]** タブを選択し、 **[今すぐ試す]** をクリックします。
1. **[モニター \| 仮想マシン]** ページで **[マップ]** タブを選択し、 **[今すぐ試す]** をクリックします。
1. **[カバレッジの管理]** ページで **[ワークスペースの構成]** を選択します。
1. **[Azure Monitor]** ページの **[Log Analytics ワークスペースの選択]** ボックスの一覧で、このラボで先ほど作成した Log Analytics ワークスペースを選択し、 **[構成]** を選択します。

   >**注**: このオプションにより、正常性モデルを使用した監視とアラートの機能が有効になります。これは、Azure Monitor for VMs によって生成されたメトリックを使用して構築される正常性監視の階層構造となっています。

## <a name="exercise-4-evaluating-monitoring-services"></a>演習 4: 監視サービスの評価

#### <a name="task-1-review-azure-monitor-monitoring-and-alerting-functionality"></a>タスク 1: Azure Monitor の監視とアラートの機能を確認する

1. **SEA-SVR2** で、Azure portal の **[監視 \| メトリック]** ページに戻ります。
1. **[スコープの選択]** ページの **[参照]** タブで **AZ801-L0901-RG** リソース グループを参照し、それを展開します。次に、そのリソース グループ内の **az801l09-vm0** 仮想マシン エントリの横にあるチェックボックスをオンにし、 **[適用]** をクリックします。

   >**注**: 一覧に **az801l09-vm0** がない場合は、 **[検索して項目をフィルター処理...]** ボックスを使用して **az801l09-vm0** を検索します。
   
   >**注**: これにより、 **[az801l09-vm0 \| メトリック]** ページにあるものと同じビューとオプションが表示されます。

1. **[メトリック]** ボックスの一覧で **[CPU 使用率]** を選択し、 **[集計]** ボックスの一覧に **[Avg]** エントリが表示されていることを確認し、結果のグラフを調べます。
1. **[モニター \| メトリック]** ページの **[az801l09-vm0 の平均 CPU 使用率]** ウィンドウで **[新しいアラート ルール]** を選択します。

   >**注**: ゲスト (クラシック) メトリック名前空間のメトリックでは、メトリックからのアラート ルールの作成はサポートされていません。 これは、Azure Resource Manager テンプレートを使用すると実行できます。ドキュメント「**[Windows 仮想マシンの Resource Manager テンプレートを使用して Azure Monitor メトリック ストアにゲスト OS メトリックを送信する](https://docs.microsoft.com/en-us/azure/azure-monitor/platform/collect-custom-metrics-guestos-resource-manager-vm)**」を参照してください。

1. **[アラート ルールの作成]** ページの **[条件]** セクションで、既存の条件エントリを選択します。
1. **[シグナル ロジックの構成]** ページのシグナルの一覧の **[アラート ロジック]** セクションで、次 の設定を指定し (他の設定は既定値のままにし)、 **[完了]** をクリックします。

   | 設定 | 値 |
   | --- | --- |
   | しきい値 | **静的** |
   | 演算子 | **より大きい** |
   | 集計の種類 | **Average** |
   | しきい値 | **2** |
   | 集計の粒度 (期間) | **1 分** |
   | 評価の頻度 | **1 分ごと** |

1. **[アラート ルールの作成]** ページの **[アクション]** タブで、 **[+ アクション グループの追加]** ボタンを選びます。
1. **[アクション グループの作成]** ページの **[基本]** タブで、次の設定を指定し (他の設定は既定値のままにして)、 **[次へ: 通知 >]** を選択します。

   | 設定 | 値 |
   | --- | --- |
   | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
   | リソース グループ | **AZ801-L0902-RG** |
   | アクション グループ名 | **az801l09-ag1** |
   | 表示名 | **az801l09-ag1** |

1. **[アクション グループの作成]** ページの **[通知]** タブにある **[通知の種類]** ボックスの一覧で **[電子メール/SMS メッセージ/プッシュ/音声]** を選択します。 **[名前]** テキスト ボックスに「**admin email**」と入力し、**[詳細の編集]** (鉛筆) アイコンをクリックします。
1. **[電子メール/SMS メッセージ/プッシュ/音声]** ページで **[電子メール]** チェックボックスをオンにし、 **[電子メール]** テキスト ボックスに自分のメール アドレスを入力します。そして、他の設定では既定値をそのままにし、 **[OK]** をクリックします。 **[アクション グループの作成]** ページの **[通知]** タブに戻り、 **[次へ: アクション >]** を選択します。
1. **[アクション グループの作成]** ページの **[アクション]** タブで、 **[アクションの種類]** ボックスの一覧に表示された項目を変更せずに確認し、 **[レビューと作成]** を選択します。
1. **[アクション グループの作成]** ページの **[レビューと作成]** タブで **[作成]** を選択します。
1. **[アラート ルールの作成]** ページに戻り、 **[アラート ルールの詳細]** セクションで、次の設定を指定します (他の設定は既定値のままにします)。

   | 設定 | 値 |
   | --- | --- |
   | アラート ルール名 | **テストしきい値を超えた CPU の割合** |
   | 説明 | **テストしきい値を超えた CPU の割合** |
   | リソース グループ | **AZ801-L0902-RG** |
   | 重大度 | **重大度 3** |
   | 作成時にルールを有効にする | **はい** |

1. **[アラート ルールの作成]** を選択します。

   >**注**: メトリックのアラート ルールがアクティブになるまでに最大 10 分かかることがあります。

1. Azure portal で、「**仮想マシン**」を検索して選択し、**[仮想マシン]** ページで **[az801l09-vm0]** を選択します。
1. **[az801l09-vm0]** ページの **[操作]** セクションで **[コマンドの実行]** を選択し、 **[RunPowerShellScript]** を選択します。
1. **[コマンド スクリプトの実行]** ページの **[PowerShell スクリプト]** セクションで、次のコマンドを入力し、 **[実行]** を選択して、ターゲット オペレーティング システム内の CPU 使用率を増やします。

   ```powershell
   $vCpuCount = Get-WmiObject Win32_Processor | Select-Object -ExpandProperty NumberOfLogicalProcessors
   ForEach ($vCpu in 1..$vCpuCount){ 
      Start-Job -ScriptBlock{
         $result = 1;
         ForEach ($loopCount in 1..2147483647){
            $result = $result * $loopCount
         }
      }
   }
   ```

   >**注**: これにより、CPU 使用率が、新しく作成されたアラート ルールのしきい値を超えて増加します。

1. **SEA-SVR2** の、Azure portal を表示している Microsoft Edge ウィンドウで、別のタブを開き、 **[モニター]** ページを参照し、 **[アラート]** を選択します。
1. **Sev 3** アラート の数を確認してから **[Sev 3]** 行を選択します。

   >**注**: 数分待ってから **[更新]** を選択する必要がある場合があります。

1. **[すべてのアラート ]** ページで、生成されたアラート を確認します。

#### <a name="task-2-review-azure-monitor-vm-insights-functionality"></a>タスク 2: Azure Monitor の VM Insights 機能を確認する

1. **SEA-SVR2** 上の Azure portal で、**az801l09-vm0** 仮想マシンのページに戻ります。
1. **az801l09-vm0** 仮想マシンのページの左側にある垂直メニューで、 **[監視]** セクションの **[Insights]** を選択します。
1. **[az801l09-vm0 \| Insights]** ページの **[パフォーマンス]** タブで、論理ディスクのパフォーマンス、CPU 使用率、使用可能なメモリ、送受信バイト数など、メトリックの既定のセットを確認します。
1. **[az801l09-vm0 \| Insights]** ページで、 **[マップ]** タブを選択し、自動生成されたマップを確認します。
1. **[az801l09-vm0 \| Insights]** ページで、 **[正常性]** タブを選択し、その内容を確認します。

   >**注**: 正常性情報を使用できるかどうかは、ワークスペースのアップグレードが完了しているかどうかによって異なります。

#### <a name="task-3-review-azure-log-analytics-functionality"></a>タスク 3: Azure Log Analytics の機能を確認する

1. **SEA-SVR2** で、Azure portal の **[モニター]** ページに戻り、 **[ログ]** を選びます。

   >**注**: Log Analytics に初めてアクセスしている場合は、 **[Log Analytics へようこそ]** ウィンドウを閉じる必要がある可能性があります。

1. **[スコープの選択]** ページで **[最近]** タブを選択します。次に、 **[az801l09-vm0]** を選択し、 **[適用]** をクリックします。
1. クエリ ウィンドウで、次のクエリを貼り付け、 **[実行]** をクリックし、結果のグラフを確認します。

   ```kql
   // Virtual Machine available memory
   // Chart the VM's available memory over the last hour.
   InsightsMetrics
   | where TimeGenerated > ago(1h)
   | where Name == "AvailableMB"
   | project TimeGenerated, Name, Val
   | render timechart
   ```

1. ツールバーの **クエリ]** [ を選択し、]**クエリ**[ ウィンドウで ]**可用性**[ ノードを展開し、] **[VM 可用性の追跡** タイルを選択します。そして、 **[実行]** をクリックし、結果を確認します。
1. **[新しいクエリ 1]** タブで **[テーブル]** ヘッダーを選択し、 **[仮想マシン]** セクションのテーブルの一覧を確認します。

   >**注**: いくつかのテーブルの名前は、このラボで以前にインストールしたソリューションに対応しています。 特に、**InsightMetrics** は、パフォーマンス メトリックを格納するために Azure VM Insights で使用されます。

1. **VMComputer** エントリの上にカーソルを移動し、 **[プレビュー データを表示]** アイコンを選択して結果を確認します。

   >**注**: データに **az801l09-vm0** と **SEA-SVR2.contoso.com** の両方のエントリが含まていることを確認してください。

   >**注**: 更新データが使用可能になるまでに、数分、待つ必要がある場合があります。

1. Azure portal の **SVR2** の **[リソース、サービス、ドキュメントの検索]** ボックスのツールバーで **[Log Analytics ワークスペース]** を検索して選択し、 **[Log Analytics ワークスペース]** ページで、このラボで先ほど作成したワークスペースを表すエントリを選択します。
1. ワークスペース ページの左側の垂直メニューの **[全般]** セクションで **[ソリューション]** を選択します。
1. ソリューションの一覧で **[ServiceMap]** を選択し、 **[概要]** ページで **[Service Map]** タイルを選択します。
1. **[ServiceMap]** ページの **[マシン]** タブで、 **[SEA-SVR2]** を選択してサービス マップを表示します。
1. 拡大して **SEA-SVR2** で使用可能なネットワーク ポートを示すマップを確認し、別のポートを選択して、対応する接続情報を確認します。
1. 接続ごとに、 **[概要]** ビューと **[プロパティ]** ビューを切り替えます。後者では、接続ターゲットに関するより詳細な情報が提供されます。

## <a name="exercise-5-deprovisioning-the-azure-environment"></a>演習 5: Azure 環境のプロビジョニング解除

#### <a name="task-1-start-a-powershell-session-in-cloud-shell"></a>タスク 1: Cloud Shell で PowerShell セッションを開始する

1. **SEA-SVR2** で、Azure portal を表示している Microsoft Edge ウィンドウにある **[Cloud Shell]** アイコンを選んで Cloud Shell ウィンドウを開きます。

#### <a name="task-2-delete-all-azure-resources-provisioned-in-the-lab"></a>タスク 2: ラボでプロビジョニングされたすべての Azure リソースを削除する

1. Cloud Shell ウィンドウで次のコマンドを実行して、このラボで作成されたすべてのリソース グループの一覧を表示します。

   ```powershell
   Get-AzResourceGroup -Name 'AZ801-L09*'
   ```

   > **メモ**: 出力に、このラボで作成したリソース グループのみが含まれていることを確認してください。 このグループが、このタスクで削除されます。

1. 次のコマンドを実行して、このラボで作成したすべてのリソース グループを削除します。

   ```powershell
   Get-AzResourceGroup -Name 'AZ801-L09*' | Remove-AzResourceGroup -Force -AsJob
   ```

   >**注**: このコマンドは非同期 ( *-AsJob* パラメーターによって決定されます) で実行されます。 そのため、同じ PowerShell セッション内で、すぐに別の PowerShell コマンドを実行できるようになりますが、リソース グループが実際に削除されるまでに数分かかります。
